#!/bin/bash

# @brief Packaging the dump, applying the header
# and transferring to dump location.
function custom_package()
{
    # shellcheck disable=SC2154 # dump_id is defined in dreport
    FILE="$TMP_DIR/dumpheader_${dump_id}_${EPOCHTIME}"
    # shellcheck disable=SC2154 # name_dir is defined in dreport
    echo "performing dump compression $name_dir"
    tar cf - -C "$(dirname "$name_dir")" "$(basename "$name_dir")"  | zstd > "$name_dir.bin"
    # shellcheck disable=SC2181 # need output from `tar` in above if cond.
    if [ $? -ne 0 ]; then
        echo "$($TIME_STAMP)" "Could not create the compressed tar file"
        rm -r "$name_dir.bin"
        return "$INTERNAL_FAILURE"
    fi

    echo "Adding Dump Header :" "$HEADER_EXTENSIONi"
    ("$HEADER_EXTENSION")

    # shellcheck disable=SC2002
    cat "$name_dir.bin" | tee -a "$FILE" > /dev/null
    #remove the temporary name specific directory
    rm -rf "$name_dir" "$name_dir.bin"
    mv "$FILE" "$name_dir"

    # shellcheck disable=SC2154 # dump_dir is defined in dreport
    echo "$($TIME_STAMP)" "Report is available in $dump_dir"
    if [ "$TMP_DIR" == "$dump_dir" ] || [ "$TMP_DIR/" == "$dump_dir" ]; then
        return "$SUCCESS"
    fi

    #copy the compressed tar file into the destination
    cp "$name_dir" "$dump_dir"
    # shellcheck disable=SC2181
    if [ $? -ne 0 ]; then
        echo "Failed to copy the $name_dir to $dump_dir"
        rm "$name_dir"
        return "$INTERNAL_FAILURE"
    fi

    #Remove the temporary copy of the file
    rm -rf "$name_dir"
}

# Executing function
custom_package
